<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - School Health Management System</title>
    <script src="/js/auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <header class="header-animated text-white p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-heartbeat text-2xl mr-2 animate-pulse"></i>
                <h1 class="text-2xl font-bold">School Health Management System</h1>
            </div>
            <nav class="flex space-x-2">
                <a href="/" class="nav-link px-3 py-2 rounded flex items-center">
                    <i class="fas fa-home mr-1"></i> Home
                </a>
                <a href="/student-blog.html" class="nav-link px-3 py-2 rounded flex items-center">
                    <i class="fas fa-blog mr-1"></i> My Blog
                </a>
                <a href="#" id="logoutBtn" class="nav-link px-3 py-2 rounded flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </a>
            </nav>
        </div>
    </header>

    <!-- Profile Section -->
    <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12 animate-fadeIn">
                    <h2 class="text-4xl font-bold mb-4 text-gradient">My Profile</h2>
                    <p class="text-xl text-gray-600">View and update your personal information</p>
                </div>

                <div id="message" class="mb-6 text-center font-medium rounded-lg py-3"></div>

                <!-- Profile Information -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold">Personal Information</h3>
                        <button id="editProfileBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-all flex items-center">
                            <i class="fas fa-edit mr-2"></i> Edit Profile
                        </button>
                    </div>

                    <!-- View Mode -->
                    <div id="profileView" class="space-y-6">
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Full Name</div>
                            <div id="viewFullName" class="w-full md:w-2/3 font-semibold">Loading...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Email</div>
                            <div id="viewEmail" class="w-full md:w-2/3">Loading...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Phone</div>
                            <div id="viewPhone" class="w-full md:w-2/3">Loading...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Date of Birth</div>
                            <div id="viewDateOfBirth" class="w-full md:w-2/3">Loading...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Gender</div>
                            <div id="viewGender" class="w-full md:w-2/3">Loading...</div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center">
                            <div class="w-full md:w-1/3 text-gray-500 font-medium">Class</div>
                            <div id="viewClassName" class="w-full md:w-2/3">Loading...</div>
                        </div>
                    </div>

                    <!-- Edit Mode (Hidden by default) -->
                    <form id="profileEditForm" class="space-y-6" style="display: none;">
                        <div class="flex flex-col">
                            <label for="editFullName" class="text-gray-500 font-medium mb-1">Full Name</label>
                            <input type="text" id="editFullName" name="fullName" 
                                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="editEmail" class="text-gray-500 font-medium mb-1">Email</label>
                            <input type="email" id="editEmail" name="email" 
                                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="editPhone" class="text-gray-500 font-medium mb-1">Phone</label>
                            <input type="text" id="editPhone" name="phone" 
                                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="editGender" class="text-gray-500 font-medium mb-1">Gender</label>
                            <select id="editGender" name="gender" 
                                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="editClassName" class="text-gray-500 font-medium mb-1">Class</label>
                            <input type="text" id="editClassName" name="className" 
                                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-all flex justify-center items-center">
                                <i class="fas fa-save mr-2"></i> Save Changes
                            </button>
                            <button type="button" id="cancelEditBtn" class="w-full bg-gray-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-600 transition-all flex justify-center items-center">
                                <i class="fas fa-times mr-2"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer py-10 text-white">
        <div class="container mx-auto px-4">
            <div class="border-t border-indigo-400 mt-8 pt-8 text-center">
                <p>&copy; 2025 School Health Management System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Check if user is authenticated
        if (!isAuthenticated()) {
            window.location.href = '/#login';
        }

        // Get current user
        const user = getCurrentUser();

        // Check if user has student role (or parent role, as student role is mapped to parent due to DB constraint)
        if (!user || (!user.roles.includes('ROLE_STUDENT') && !user.roles.includes('ROLE_PARENT'))) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'bg-red-100 text-red-700 p-4 rounded-lg';
            messageDiv.textContent = 'You do not have permission to access this page. Only students can view their profile.';
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('editProfileBtn').style.display = 'none';
        }

        // Load profile data
        function loadProfileData() {
            sendAuthenticatedRequest('/api/student-profile')
                .then(response => response.json())
                .then(data => {
                    // Update view mode
                    document.getElementById('viewFullName').textContent = data.fullName || 'Not provided';
                    document.getElementById('viewEmail').textContent = data.email || 'Not provided';
                    document.getElementById('viewPhone').textContent = data.phone || 'Not provided';
                    document.getElementById('viewDateOfBirth').textContent = data.dateOfBirth ? new Date(data.dateOfBirth).toLocaleDateString() : 'Not provided';
                    document.getElementById('viewGender').textContent = data.gender || 'Not provided';
                    document.getElementById('viewClassName').textContent = data.className || 'Not provided';

                    // Update edit form
                    document.getElementById('editFullName').value = data.fullName || '';
                    document.getElementById('editEmail').value = data.email || '';
                    document.getElementById('editPhone').value = data.phone || '';

                    const genderSelect = document.getElementById('editGender');
                    if (data.gender) {
                        for (let i = 0; i < genderSelect.options.length; i++) {
                            if (genderSelect.options[i].value === data.gender) {
                                genderSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    document.getElementById('editClassName').value = data.className || '';
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                    const messageDiv = document.getElementById('message');
                    messageDiv.className = 'bg-red-100 text-red-700 p-4 rounded-lg';
                    messageDiv.textContent = 'Error loading profile data. Please try again later.';
                });
        }

        // Toggle between view and edit modes
        document.getElementById('editProfileBtn').addEventListener('click', function() {
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('profileEditForm').style.display = 'block';
            document.getElementById('editProfileBtn').style.display = 'none';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', function() {
            document.getElementById('profileView').style.display = 'block';
            document.getElementById('profileEditForm').style.display = 'none';
            document.getElementById('editProfileBtn').style.display = 'block';
        });

        // Handle profile update
        document.getElementById('profileEditForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                fullName: document.getElementById('editFullName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                gender: document.getElementById('editGender').value,
                className: document.getElementById('editClassName').value
            };

            sendAuthenticatedRequest('/api/student-profile', {
                method: 'PUT',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');

                if (data.success) {
                    messageDiv.className = 'bg-green-100 text-green-700 p-4 rounded-lg';
                    messageDiv.textContent = data.message;

                    // Switch back to view mode
                    document.getElementById('profileView').style.display = 'block';
                    document.getElementById('profileEditForm').style.display = 'none';
                    document.getElementById('editProfileBtn').style.display = 'block';

                    // Reload profile data
                    loadProfileData();
                } else {
                    messageDiv.className = 'bg-red-100 text-red-700 p-4 rounded-lg';
                    messageDiv.textContent = data.message || 'Error updating profile. Please try again.';
                }
            })
            .catch(error => {
                console.error('Error updating profile:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'bg-red-100 text-red-700 p-4 rounded-lg';
                messageDiv.textContent = 'Error updating profile. Please try again later.';
            });
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });

        // Load profile data on page load
        loadProfileData();
    </script>
</body>
</html>
